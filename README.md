IMR Auto Data Collector
===

## About this project

This project allows you to collect RGB, depth, mask of objects automatically using GAZEBO and ROS

This document will walk you through the following topics:
- Project Setup
- How to run this project
- Code Explained
- How to modify models and worlds
    1. how to change model position, lighting, collision, dimension ...etc
    2. how to change camera intrinsics
    3. how to save your world and roslanch it
- Problem log
- More
    1. How to process data into Linemod dataset format
    2. onenote link



## Project Setup

#### 1. setup gazebo world file
```script
export GAZEBO_RESOURCE_PATH=path/to/worlds.
``` 

* so gazebo can use the .world files in this package

#### 2. setup gazebo launch file
-    you can use roscd to find the launch file directory
```script
roscd gazebo_ros
cd launch
``` 
- put the launch files in /launchfiles into <gazebo_ros_dir>/launch

## How to run this project
since the world for collecting rgb&depth and mask are differnet, you need to collect them seperatly

- #### Generate random camera poses
    ```sh
    . generate_camera_pose.sh 1000
    ``` 
    -    this script generate 1000 random camera poses and store them in camera_poses.yml
    -    p.s. camera always points at (x, y, z) = (0.0, 0.0, 0.28)
         you can change them in the code
- #### Collecting rgb&depth images
    1. start IMR world with normal lighting
    ```sh
    roslaunch gazebo_ros IMR_DF_NORMAL.world
    ``` 
    2. run data collector script
    ```sh
    . collect_rgb_and_depth.sh
    ``` 
    
- #### Collecting mask images
    1. start IMR world with no lighting
    ```sh
    roslaunch gazebo_ros IMR_DF_MASK.world
    ``` 
    2. run data collector script
    ```sh
    . collect_mask.sh
    ``` 
- #### Output
    -    you can find collected data in data/0001
    - 0001
    |__depth: depth images
    |__info:  camera_poses.yml, *object_pose.yml, *object_color.yml
    |__mask: mask images
    |__rgb: rgb images
    
    ** you have to modify these files manually if you change the object poses/color of the world
## Code Explained

* ### Purpose of each python script

    1. camera_pose_generator.py
        - This python script generates number of 6D poses and store them into txt
        - Usage
        `python camera_pose_generator.py 1000`
        - How this file generates camera pose?
            - this python script generates random camera z (height), r (distance to the target point), roll, and theta. 
            ![](https://i.imgur.com/uQnPV0V.jpg)
            - the yaw and pitch of the camera are derived from pointing camera at a target point


    2. camera_mover.py
        - this script read the 6D poses generate by pos_script_generator.py and moves the camera in GAZEBO, once done moveing the camera , it will send a saving signal to image_saver.py to save the current camera image.
        - if you're collecting rgb and depth images
        `python camera_scripting.py`
        - if your're collecting mask images
        `python camera_scripting.py --mask`
    3. image_saver.py
        - waits for saving signal and save images
* ### If you want to run these python scripts manually...
    
    * because the world for collecting rgb&depth images and the world for collecting mask image are diffenet, so you need to collect them seperatly.


	#### A. Generate random camera position 
 
    -  generate 1000 random camera poses
    
        ```script
	    python camera_pose_generator.py 1000
        ``` 
    - this python script will generates camera_poses.yml
    - p.s. you need to change the python code if you want to point camera at different location
    
	#### B. Collecting RGB&depth and Mask Images
    
    - you need to run the following steps in order
    
	1. Terminal tab 1 : launch gazebo world
	    - For collecting RGB&depth images
	    ```script
	    roslaunch gazebo_ros IMR_DF_NORMAL.launch 
	    ```
	    
	    - For collecting Mask images
	    ```script
	    roslaunch gazebo_ros IMR_DF_MASK.launch 
	    ```	
			
	2. Terminal tab 2 : launch image saver
	    ```script
	    python image_saver.py
	    ```	
	
	
		- Opens a cv2 window to show current camera feed
		- waits for saving trigger and saves images
	
	3. Terminal tab 3 : launch camera mover
	    - For collecting RGB&depth images
	    ```script
	    python camera_mover.py
	    ```	
        - For collecting Mask images
        ```script
	    python camera_mover.py --mask
	    ```	
        
		- moves camera by script (generated by camera_pose_generator.py )
		- send image saving trigger 
		* --  -- mask, save only rgb image to mask folder


## How to modify models and worlds
1. How to change model lighting, collision, dimension ...etc

    - model files are in ~/.gazebo/models
    - under each model folder you can probably find:
        - /meshes
            - model geometry files like: chimp.dae
        - model.config
            - config file
        - model.sdf
            - gazebo properties file
            - contains lighting, collision, physics...properties

        - example: sdf file of linemod chimp    
		    - your can delete `<collision>` if you want a ghost object 
            - set `<static>` to 1 so your object won't move due to the gravity or other forces
        ---
        ```xml
		<?xml version='1.0'?>
		<sdf version='1.6'>
		  <model name='densefusion_chimp'>
		    <link name='link_2'>
		      <pose frame=''>0 0 0 0 -0 0</pose>
		        <visual name='visual'>
		        <pose frame=''>0 0 0 0 -0 0</pose>
		        <geometry>
		          <mesh>
		            <uri>model://densefusion_chimp/meshes/chimp.dae</uri>
		            <scale>0.001 0.001 0.001</scale>
		          </mesh>
		        </geometry>
		        <material>
		          <lighting>1</lighting>
		          <ambient>0.06 0.06 0.06 0.1</ambient>
		          <diffuse>0.2 0.2 0.2 1</diffuse>
		          <specular>0.9 0.9 0.9 1</specular>
		          <emissive>0 0 0 1</emissive>
		        </material>
		        <cast_shadows>1</cast_shadows>
		        <transparency>0</transparency>
		      </visual>
		      <collision name='collision'>
		        <laser_retro>0</laser_retro>
		        <max_contacts>10</max_contacts>
		        <pose frame=''>0 0 0 0 -0 0</pose>
		        <geometry>
		          <mesh>
		            <uri>model://densefusion_chimp/meshes/chimp.dae</uri>
		            <scale>0.001 0.001 0.001</scale>
		          </mesh>
		        </geometry>
		        
		      </collision>
		    </link>
		   
		    <static>1</static>
		    <allow_auto_disable>1</allow_auto_disable>
		  </model>
		</sdf>
		
		```
2. how to change camera intrinsics

    -    this is the sdf file of gazebo depth camera (kinect_ros)
    -    modify `<horizontal_fov>` tag to change hfov
    -    modify `<clip>` tag so your image don't get clip
    ---
    ```xml
	<?xml version="1.0" ?>
	<sdf version="1.6">
	  <model name="kinect_ros">
	    <static>true</static>
	    <pose>0 0 0.036 0 0 0</pose>
	    <gazebo>
	    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
	    <robotNamespace>/MYROBOT</robotNamespace>
	    </plugin>
	    </gazebo>
	    <link name="link">
	      <inertial>
	        <mass>0.1</mass>
	      </inertial>
	 
	      <visual name="visual">
	        <geometry>
	          <mesh>
	            <uri>model://kinect/meshes/kinect.dae</uri>
	          </mesh>
	        </geometry>
	      </visual>
	      <sensor name="camera" type="depth">
	        <update_rate>20</update_rate>
	        <camera>
	          <horizontal_fov>1.0195121</horizontal_fov>
	          <image>
	            <width>640</width>
	            <height>480</height>
	            <format>R8G8B8</format>
	          </image>
	          <clip>
	            <near>0.01</near>
	            <far>10</far>
	          </clip>
	        </camera>
	        <plugin name="camera_plugin" filename="libgazebo_ros_openni_kinect.so">
	          <baseline>0.2</baseline>
	          <alwaysOn>true</alwaysOn>
	          <!-- Keep this zero, update_rate in the parent <sensor> tag
	            will control the frame rate. -->
	          <updateRate>0.0</updateRate>
	          <cameraName>camera_ir</cameraName>
	          <imageTopicName>/camera/color/image_raw</imageTopicName>
	          <cameraInfoTopicName>/camera/color/camera_info</cameraInfoTopicName>
	          <depthImageTopicName>/camera/depth/image_raw</depthImageTopicName>
	          <depthImageCameraInfoTopicName>/camera/depth/camera_info</depthImageCameraInfoTopicName>
	          <pointCloudTopicName>/camera/depth/points</pointCloudTopicName>
	          <frameName>camera_link</frameName>
	          <pointCloudCutoff>0.01</pointCloudCutoff>
	          <pointCloudCutoffMax>10</pointCloudCutoffMax>
	          <distortionK1>0</distortionK1>
	          <distortionK2>0</distortionK2>
	          <distortionK3>0</distortionK3>
	          <distortionT1>0</distortionT1>
	          <distortionT2>0</distortionT2>
	          <CxPrime>0</CxPrime>
	          <Cx>0</Cx>
	          <Cy>0</Cy>
	          <focalLength>0</focalLength>
	          <hackBaseline>0</hackBaseline>
	        </plugin>
	      </sensor>
	    </link>
	  </model>
	</sdf>
       
	```

		
4. how to save your world and roslanch it

    - after setting up your gazebo world, you can save it using the gazebo GUI
    - if you want to save your .world file in other locataion, do
        `export GAZEBO_RESOURCE_PATH='location/you/want'`
    - to launch your world using roslaunch
        - the easist way is to include empty_world.launch (GAZEBO example world)
        - you can use roscd to find launch files
        `roscd gazebo_ros`
        - launch files are under /launch folder
        - example: .world file below
---
```xml
<?xml version="1.0"?>
<launch>

  <!-- We resume the logic in empty_world.launch, changing only the name of the world to be launched -->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="world_name" value="IMR_DF_NORMAL.world"/> <!-- Note: the world_name is with respect to GAZEBO_RESOURCE_PATH environmental variable -->
    <arg name="paused" value="false"/>
    <arg name="use_sim_time" value="true"/>
    <arg name="gui" value="true"/>
    <arg name="headless" value="false"/> <!-- Inert - see gazebo_ros_pkgs issue #491 -->
    <arg name="recording" value="false"/>
    <arg name="debug" value="false"/>
  </include>

</launch>

```
## Problems log
1. Can't use kinect depth camera
- add original kinect camera into .gazebo
    - depth camera [tutorial](http://gazebosim.org/tutorials/?tut=ros_depth_camera)
    - download link http://github.com/osrf/gazebo_tutorials/raw/master/ros_depth_camera/files/kinect.zip
    
-    if adding kinect doesn't work, try re-install gazebo
    -    re-install gazebo_ros_pkg
    -    follow [official website tutorial](http://gazebosim.org/tutorials?tut=ros_installing&cat=connect_ros)
    -    follow B. Install from Source (on Ubuntu)		

## More
1. How to process data into Linemod dataset format
-    see this [repo](http://github.com/Sciencethebird/IMR_linemod_generator) 
2. OneNote link
		
		
###### tags: `GAZEBO` `ROS` `IMR` `Documentation`
		
